#!/bin/bash
set -euo pipefail

# OpenScan3 Updater
# - Force-resets /opt/openscan3-src to <remote>/<branch>
# - Syncs to /opt/openscan3 (no .git)
# - Rebuilds venv and reinstalls package (editable)
# - Resets /etc/openscan3 from src settings (unless --keep-settings)
# - Downloads and deploys latest OpenScan3-Client SPA from GitHub releases

# === Configuration ===
SRC_DIR="/opt/openscan3-src"
DST_DIR="/opt/openscan3"
SETTINGS_DIR="/etc/openscan3"
CLIENT_DIR="/opt/openscan3-client"
GITHUB_REPO="esto-openscan/OpenScan3-Client"
SPA_ZIP="spa.zip"
GITHUB_RELEASE_URL="https://github.com/${GITHUB_REPO}/releases/latest/download/${SPA_ZIP}"
DEFAULT_BRANCH="develop"

BRANCH=""
KEEP_SETTINGS=0

while [[ $# -gt 0 ]]; do
  case "$1" in
    --branch)
      BRANCH="$2"; shift 2;;
    --keep-settings)
      KEEP_SETTINGS=1; shift;;
    -h|--help)
      echo "Usage: $0 [--branch <name>] [--keep-settings]"; exit 0;;
    *)
      echo "Unknown arg: $1"; echo "Usage: $0 [--branch <name>] [--keep-settings]"; exit 1;;
  esac
done

log() { echo "[openscan3-update] $*"; }
err() { echo "[openscan3-update] ERROR: $*" >&2; }

git config --system --add safe.directory "${SRC_DIR}" || true

# Detect the primary remote (first available)
get_remote() {
  runuser -u openscan -- git -C "${SRC_DIR}" remote 2>/dev/null | head -n1 || true
}

# Determine branch: use provided, or current, or default
if [[ -z "${BRANCH}" && -d "${SRC_DIR}/.git" ]]; then
  CURRENT_BRANCH=$(runuser -u openscan -- git -C "${SRC_DIR}" rev-parse --abbrev-ref HEAD 2>/dev/null || true)
  if [[ -n "${CURRENT_BRANCH}" && "${CURRENT_BRANCH}" != "HEAD" ]]; then
    BRANCH="${CURRENT_BRANCH}"
  fi
fi
: "${BRANCH:=${DEFAULT_BRANCH}}"

REMOTE=$(get_remote)
if [[ -z "${REMOTE}" ]]; then
  err "No git remote found in ${SRC_DIR}"
  exit 1
fi

log "Stopping services..."
pkill -9 -f "python.*openscan" || true
pkill -9 -f "/opt/openscan3/venv/bin/python" || true

log "Updating source repo at ${SRC_DIR} to ${REMOTE}/${BRANCH}..."
runuser -u openscan -- bash -lc "set -e; cd '${SRC_DIR}'; git fetch '${REMOTE}' --prune"

# Verify branch exists on remote
if ! runuser -u openscan -- git -C "${SRC_DIR}" rev-parse --verify "${REMOTE}/${BRANCH}" >/dev/null 2>&1; then
  err "Branch '${BRANCH}' not found on remote '${REMOTE}'"
  log "Available branches:"
  runuser -u openscan -- git -C "${SRC_DIR}" branch -r | grep "^  ${REMOTE}/" | sed "s|  ${REMOTE}/||" || true
  exit 1
fi

runuser -u openscan -- bash -lc "set -e; cd '${SRC_DIR}'; git checkout -B '${BRANCH}' '${REMOTE}/${BRANCH}'; git reset --hard '${REMOTE}/${BRANCH}'; git clean -fdx"

log "Syncing source to working tree ${DST_DIR} (excluding .git)..."
rsync -a --delete --exclude '.git' "${SRC_DIR}/" "${DST_DIR}/"

log "Recreating venv and reinstalling package..."
rm -rf "${DST_DIR}/venv"
runuser -u openscan -- python3 -m venv --system-site-packages "${DST_DIR}/venv"
log "Installing editable package from ${DST_DIR}"
runuser -u openscan -- bash -lc "set -e; source '${DST_DIR}/venv/bin/activate'; pip install --upgrade pip; pip install -e '${DST_DIR}'"

if [[ ${KEEP_SETTINGS} -eq 0 ]]; then
  log "Resetting settings in ${SETTINGS_DIR} from ${SRC_DIR}/settings (if present)..."
  find "${SETTINGS_DIR}" -mindepth 1 -maxdepth 1 -exec rm -rf {} + || true
  if [[ -d "${SRC_DIR}/settings" ]]; then
    cp -a "${SRC_DIR}/settings/." "${SETTINGS_DIR}/"
  fi
  chown -R openscan:openscan "${SETTINGS_DIR}"
  find "${SETTINGS_DIR}" -type d -exec chmod 2775 {} +
  find "${SETTINGS_DIR}" -type f -exec chmod 664 {} +
  setfacl -Rm g::rwX "${SETTINGS_DIR}" || true
  setfacl -Rdm g::rwX "${SETTINGS_DIR}" || true
  setfacl -Rm m::rwX "${SETTINGS_DIR}" || true
  setfacl -Rdm m::rwX "${SETTINGS_DIR}" || true
fi

log "Downloading latest OpenScan3-Client from GitHub releases..."
TMP_DIR=$(mktemp -d)
trap "rm -rf '${TMP_DIR}'" EXIT

ZIP_FILE="${TMP_DIR}/${SPA_ZIP}"
log "Downloading from ${GITHUB_RELEASE_URL}..."
curl -fsSL -o "${ZIP_FILE}" "${GITHUB_RELEASE_URL}"
if [[ ! -f "${ZIP_FILE}" ]]; then
  log "ERROR: Failed to download client archive"
  exit 1
fi

log "Extracting client to ${CLIENT_DIR}..."
rm -rf "${CLIENT_DIR}"
install -d "${CLIENT_DIR}"
unzip -q "${ZIP_FILE}" -d "${CLIENT_DIR}"

log "Setting permissions for ${CLIENT_DIR}..."
chown -R www-data:www-data "${CLIENT_DIR}"
find "${CLIENT_DIR}" -type d -exec chmod 755 {} +
find "${CLIENT_DIR}" -type f -exec chmod 644 {} +

log "Client deployment complete"

log "Restarting services..."
systemctl restart openscan3 || true

log "Done."
